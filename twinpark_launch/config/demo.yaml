# TwinPark System Unified Configuration
# This file contains all parameters for the complete system

# ============================================================================
# CARLA Bridge Configuration
# ============================================================================
carla:
  # CARLA server connection
  host: "localhost"
  port: 2000
  timeout: 10.0
  
  # Vehicle selection filter
  vehicle_filter: "haut"
  
  # Vehicle spawn point (ROS coordinates)
  # ROS frame: yaw=0° points right (+X), yaw=90° points up (+Y)
  spawn_point:
    x: -18.3      # ROS X coordinate
    y: -5.68     # ROS Y coordinate  
    z: 0.05
    yaw: 90.0     # degrees in ROS frame (vehicle should point up/+Y for forward parking)
  
  # Coordinate transformation (CARLA -> ROS)
  coordinate_transform:
    x_scale: -1.0      # CARLA X -> ROS -X
    y_scale: 1.0       # CARLA Y -> ROS Y
    yaw_offset: 180.0    # No offset, just mirror yaw
  
  # Vehicle parameters
  wheelbase: 3.368  # meters
  
  # Publishing rate
  publish_rate: 50.0  # Hz

# ============================================================================
# Planner Configuration (loaded into /planner_node namespace)
# ============================================================================
planner_node:
  # Hybrid A* Parameters
  xy_resolution: 0.755      # Grid resolution in meters
  yaw_resolution: 10.0      # Angle resolution in degrees
  
  # Vehicle Geometry
  wheelbase: 3.368          # Wheelbase in meters
  width: 2.857              # Vehicle width in meters 1.8
  length: 4.955             # Vehicle length in meters 4.5
  max_steer: 40.0           # Maximum steering angle in degrees
  min_turn_radius: 5.0      # Minimum turning radius in meters
  
  # Speed Planning Parameters
  max_speed: 1.0            # Maximum speed in m/s
  max_accel: 1.0            # Maximum acceleration in m/s²
  max_jerk: 0.5             # Maximum jerk in m/s³
  curvature_speed_factor: 0.5  # Factor for speed reduction based on curvature
  
  # Goal Configuration (ROS coordinates)
  goal_x: -25.8             # Goal X position in meters (ROS coordinate)
  goal_y: 0.1               # Goal Y position in meters (ROS coordinate)
  goal_yaw: 0.0             # Goal yaw angle in degrees (pointing right/east in ROS frame)
  
  # 车位L4 -25.8 0.1 180.0


  # Auto Planning
  auto_plan: true           # Automatically plan when vehicle state is received
  
  # Obstacle Map Configuration
  obstacles:
    x_bounds: [9.476, 27.401]    # X bounds of the environment
    y_bounds: [-10.101, 14.377]  # Y bounds of the environment

    static_vehicles:
      - name: "L2"
        x: 23.8      # 障碍车L2
        y: 7.1
        yaw: 180.0
      - name: "L6"
        x: 24.0      # 障碍车L6
        y: -6.7       
        yaw: 180.0
      - name: "R2"
        x: 13.9      # 障碍车R2
        y: 8.7
        yaw: 30.0
      - name: "R4"
        x: 12.7      # 障碍车R4
        y: 0.1
        yaw: 0.0
      - name: "R5"
        x: 13.2      # 障碍车R5
        y: -4.3
        yaw: -24.0

    # Parking slots (for reference, not used as obstacles)
    parking_slots:
      - row: 1
        col: 3
        x: 23.8 
        y: 0.1
        yaw: 180.0
      - row: 2
        col: 3
        x: 12.8
        y: 0.1
        yaw: 0.0

# ============================================================================
# Trajectory Server Configuration
# ============================================================================
traj_server:
  # Publishing frequency (Hz)
  publish_rate: 50.0
  
  # Time scaling factor
  # 1.0 = normal speed, 0.5 = slow motion, 2.0 = fast forward
  time_scale: 1.0
  
  # Interpolation method
  interpolation_method: "linear"
  
  # Loop trajectory
  loop_trajectory: false

# ============================================================================
# Vehicle Control Configuration
# ============================================================================
vehicle_control:
  # Backstepping Controller Parameters
  k1: 4.0    # Longitudinal error gain (increased to reduce tracking lag)
  k2: 2.5    # Lateral error gain (moderate to balance response)
  k3: 2.0    # Heading error gain (moderate to avoid excessive steering)
  
  # PID Speed Controller Parameters
  pid:
    kp: 2.0           # Proportional gain (increased for faster speed response)
    ki: 0.2           # Integral gain (increased to eliminate steady-state error)
    kd: 0.3           # Derivative gain (increased for better damping)
    max_integral: 1.0 # Anti-windup limit
  
  # Control Limits
  max_throttle: 1.0       # Maximum throttle [0, 1]
  max_brake: 1.0          # Maximum brake [0, 1]
  max_steer: 1.0          # Maximum steering [-1, 1]
  
  # Vehicle Parameters
  wheelbase: 3.368        # Vehicle wheelbase (m)
  
  # Control Rate
  publish_rate: 50.0      # Control loop frequency (Hz)

# ============================================================================
# MPPI Control Configuration
# ============================================================================
mppi_control_node:
  # MPPI Algorithm Parameters
  delta_t: 0.05              # Time step for prediction (s)
  horizon_T: 40             # Prediction horizon steps (1.0s lookahead, balanced)
  num_samples_K: 500        # Number of sampled trajectories (reduced for speed)
  exploration: 0.1         # Exploration ratio (0-1) - increased for better reverse exploration
  lambda: 40.0              # Temperature parameter - 适当放宽选择，利用更多样本的平均值来平滑输出
  alpha: 0.6               # 平滑系数，遵循上一步控制量的程度，让控制器对当前的误差反应更灵敏。
  
  # Noise Parameters (Covariance)
  sigma_steer: 0.3          # Steering noise std dev (rad) - 扩大搜索范围，让控制器敢于尝试大角度转向。
  sigma_accel: 0.1          # Acceleration noise std dev (m/s²) - increased for better reverse exploration
  
  # Cost Function Weights [lateral_error, yaw, v]
  # Stage cost: balanced weights for smooth path following
  # Terminal cost: emphasize accurate final position
  # Note: Increased velocity weight to ensure proper speed tracking in reverse
  stage_cost_weight: [20.0, 60.0, 60.0, 5.0]      # Stage cost weights [e_lon, e_lat, e_yaw, e_v] - v increased
  terminal_cost_weight: [50.0, 100.0, 80.0, 5.0]   # Terminal cost weights [e_lon, e_lat, e_yaw, e_v] - v increased
  
  # Vehicle Parameters
  wheelbase: 3.368          # Vehicle wheelbase (m)
  max_steer: 45.0           # Maximum steering angle (degrees)
  max_accel: 0.8            # Maximum acceleration (m/s²)
  
  # Control Rate
  publish_rate: 20.0        # Control loop frequency (Hz)

# ============================================================================
# Hybrid A*-Guided MPPI Configuration (Optimized for Parking)
# ============================================================================
hybrid_mppi_control:
  delta_t: 0.05
  horizon_T: 40              # 2.0s 视界，提高前瞻性
  num_samples_K: 800         # 增加采样数，提高优化质量
  exploration: 0.05
  
  # 核心参数优化 - 大幅提高误差权重
  lambda: 30.0          # 降低温度，更关注低代价轨迹
  alpha: 0.1            # 降低平滑系数，更关注当前误差
  
  sigma_steer: 0.12     # 增加探索
  sigma_vel: 0.3        # 增加探索
  
  # 权重大幅提升 - 减少对前馈的依赖
  stage_cost_weight: [50.0, 100.0, 120.0, 150.0]      
  terminal_cost_weight: [200.0, 300.0, 400.0, 100.0]  # 终端权重极大提升 
  
  wheelbase: 3.368
  max_steer: 45.0
  max_accel: 1.5             # 限制最大加速度输出，物理上减缓震荡
  publish_rate: 20.0
  max_speed_abs: 2.0
